{"cells":[{"cell_type":"markdown","metadata":{"id":"KxboOlSAe1Cp"},"source":["# Импорт библиотек"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"j5iRzlLUdBAh","outputId":"2d2a97b4-346c-4fe1-c90e-87f0ded1fa69","executionInfo":{"status":"ok","timestamp":1719323676920,"user_tz":-180,"elapsed":18010,"user":{"displayName":"Loraq","userId":"14699525697725059408"}}},"outputs":[{"output_type":"stream","name":"stdout","text":["Requirement already satisfied: bokeh in /usr/local/lib/python3.10/dist-packages (3.3.4)\n","Requirement already satisfied: Jinja2>=2.9 in /usr/local/lib/python3.10/dist-packages (from bokeh) (3.1.4)\n","Requirement already satisfied: contourpy>=1 in /usr/local/lib/python3.10/dist-packages (from bokeh) (1.2.1)\n","Requirement already satisfied: numpy>=1.16 in /usr/local/lib/python3.10/dist-packages (from bokeh) (1.25.2)\n","Requirement already satisfied: packaging>=16.8 in /usr/local/lib/python3.10/dist-packages (from bokeh) (24.1)\n","Requirement already satisfied: pandas>=1.2 in /usr/local/lib/python3.10/dist-packages (from bokeh) (2.0.3)\n","Requirement already satisfied: pillow>=7.1.0 in /usr/local/lib/python3.10/dist-packages (from bokeh) (9.4.0)\n","Requirement already satisfied: PyYAML>=3.10 in /usr/local/lib/python3.10/dist-packages (from bokeh) (6.0.1)\n","Requirement already satisfied: tornado>=5.1 in /usr/local/lib/python3.10/dist-packages (from bokeh) (6.3.3)\n","Requirement already satisfied: xyzservices>=2021.09.1 in /usr/local/lib/python3.10/dist-packages (from bokeh) (2024.6.0)\n","Requirement already satisfied: MarkupSafe>=2.0 in /usr/local/lib/python3.10/dist-packages (from Jinja2>=2.9->bokeh) (2.1.5)\n","Requirement already satisfied: python-dateutil>=2.8.2 in /usr/local/lib/python3.10/dist-packages (from pandas>=1.2->bokeh) (2.8.2)\n","Requirement already satisfied: pytz>=2020.1 in /usr/local/lib/python3.10/dist-packages (from pandas>=1.2->bokeh) (2023.4)\n","Requirement already satisfied: tzdata>=2022.1 in /usr/local/lib/python3.10/dist-packages (from pandas>=1.2->bokeh) (2024.1)\n","Requirement already satisfied: six>=1.5 in /usr/local/lib/python3.10/dist-packages (from python-dateutil>=2.8.2->pandas>=1.2->bokeh) (1.16.0)\n","Requirement already satisfied: selenium in /usr/local/lib/python3.10/dist-packages (4.22.0)\n","Requirement already satisfied: urllib3[socks]<3,>=1.26 in /usr/local/lib/python3.10/dist-packages (from selenium) (2.0.7)\n","Requirement already satisfied: trio~=0.17 in /usr/local/lib/python3.10/dist-packages (from selenium) (0.25.1)\n","Requirement already satisfied: trio-websocket~=0.9 in /usr/local/lib/python3.10/dist-packages (from selenium) (0.11.1)\n","Requirement already satisfied: certifi>=2021.10.8 in /usr/local/lib/python3.10/dist-packages (from selenium) (2024.6.2)\n","Requirement already satisfied: typing_extensions>=4.9.0 in /usr/local/lib/python3.10/dist-packages (from selenium) (4.12.2)\n","Requirement already satisfied: websocket-client>=1.8.0 in /usr/local/lib/python3.10/dist-packages (from selenium) (1.8.0)\n","Requirement already satisfied: attrs>=23.2.0 in /usr/local/lib/python3.10/dist-packages (from trio~=0.17->selenium) (23.2.0)\n","Requirement already satisfied: sortedcontainers in /usr/local/lib/python3.10/dist-packages (from trio~=0.17->selenium) (2.4.0)\n","Requirement already satisfied: idna in /usr/local/lib/python3.10/dist-packages (from trio~=0.17->selenium) (3.7)\n","Requirement already satisfied: outcome in /usr/local/lib/python3.10/dist-packages (from trio~=0.17->selenium) (1.3.0.post0)\n","Requirement already satisfied: sniffio>=1.3.0 in /usr/local/lib/python3.10/dist-packages (from trio~=0.17->selenium) (1.3.1)\n","Requirement already satisfied: exceptiongroup in /usr/local/lib/python3.10/dist-packages (from trio~=0.17->selenium) (1.2.1)\n","Requirement already satisfied: wsproto>=0.14 in /usr/local/lib/python3.10/dist-packages (from trio-websocket~=0.9->selenium) (1.2.0)\n","Requirement already satisfied: pysocks!=1.5.7,<2.0,>=1.5.6 in /usr/local/lib/python3.10/dist-packages (from urllib3[socks]<3,>=1.26->selenium) (1.7.1)\n","Requirement already satisfied: h11<1,>=0.9.0 in /usr/local/lib/python3.10/dist-packages (from wsproto>=0.14->trio-websocket~=0.9->selenium) (0.14.0)\n","/bin/bash: line 1: conda: command not found\n","Cloning into 'my_works'...\n","remote: Enumerating objects: 3, done.\u001b[K\n","remote: Counting objects: 100% (3/3), done.\u001b[K\n","remote: Total 3 (delta 0), reused 0 (delta 0), pack-reused 0\u001b[K\n","Receiving objects: 100% (3/3), done.\n","/content/my_works/my_works/my_works\n"]}],"source":["!pip install bokeh\n","!pip install selenium\n","!conda install -c conda-forge firefox geckodriver\n","import pandas as pd\n","import bokeh\n","from bokeh.models import Title\n","from bokeh.io import output_notebook\n","from bokeh.plotting import figure, show\n","from typing import Union, List, Optional\n","import numpy as np\n","\n","output_notebook()\n","\n"]},{"cell_type":"markdown","metadata":{"id":"1ma-DdRVgi1v"},"source":["# Рабочая среда\n","\n"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"HBZeIbj9Bk9x"},"outputs":[],"source":["df = pd.read_parquet('/content/drive/MyDrive/Colab Notebooks/Vlados_work/draft/base_data.parquet', )\n","df.rename(columns={'open_futures': 'open',\n","                   'high_futures': 'high',\n","                   'low_futures': 'low',\n","                   'close_futures': 'close',\n","                   'first_volume_futures': 'volume',\n","                   'timestamp': 'datetime'},\n","                   inplace=True)\n","\n","# Преобразование столбца 'datetime' в тип данных datetime\n","df['date'] = df.datetime.dt.date\n","\n","df = df[:5000]"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"prwJvc3ydsd7"},"outputs":[],"source":["def customize_plot_styles(p):\n","    p.background_fill_color = \"#181c27\"\n","    p.background_fill_alpha = 1\n","\n","    p.xaxis.major_label_orientation = \"horizontal\"\n","\n","    p.xaxis.axis_label_text_color = \"#b2b5be\"\n","    p.xaxis.major_label_text_color = \"#b2b5be\"\n","    p.xaxis.axis_line_width = 1.0\n","    p.xaxis.axis_line_color = \"#2a2e39\"\n","\n","    p.yaxis.minor_tick_line_color = None\n","    p.xaxis.minor_tick_line_color = None\n","\n","    p.yaxis.axis_label_text_color = \"#b2b5be\"\n","    p.yaxis.major_label_text_color = \"#b2b5be\"\n","    p.yaxis.axis_line_width = 1.0\n","    p.yaxis.axis_line_color = \"#2a2e39\"\n","\n","    p.xaxis.major_tick_line_color = \"#2a2e39\"\n","    p.yaxis.major_tick_line_color = \"#2a2e39\"\n","\n","    p.border_fill_color = \"#181c27\"\n","    p.grid.grid_line_color = \"#2a2e39\"\n","    p.outline_line_color = \"#2a2e39\"\n","\n","    p.xgrid.grid_line_dash = [2, 2]\n","    p.ygrid.grid_line_dash = [2, 2]\n","    p.xgrid.grid_line_alpha = 0\n","    p.ygrid.grid_line_alpha = 0\n","\n","    p.xaxis.major_tick_line_color = None  # Убрать линии тиков по оси X\n","    p.yaxis.major_tick_line_color = None  # Убрать линии тиков по оси Y\n","\n","    p.toolbar.autohide = True\n","\n","\n","\n"]},{"cell_type":"code","source":["from bokeh.plotting import figure, show, ColumnDataSource\n","from bokeh.models import Span, LabelSet, HoverTool, Slider, DatePicker, Toggle, CrosshairTool, FreehandDrawTool\n","from bokeh.layouts import column, row\n","from bokeh.models.formatters import DatetimeTickFormatter\n","from bokeh.models.callbacks import CustomJS\n","import pandas as pd\n","import numpy as np\n","from typing import Optional, List, Union\n","\n","\n","def customize_plot_styles(p):\n","    p.background_fill_color = \"#181c27\"\n","    p.background_fill_alpha = 1\n","    p.xaxis.major_label_orientation = \"horizontal\"\n","    p.xaxis.axis_label_text_color = \"#b2b5be\"\n","    p.xaxis.major_label_text_color = \"#b2b5be\"\n","    p.xaxis.axis_line_width = 1.0\n","    p.xaxis.axis_line_color = \"#2a2e39\"\n","    p.yaxis.minor_tick_line_color = None\n","    p.xaxis.minor_tick_line_color = None\n","    p.yaxis.axis_label_text_color = \"#b2b5be\"\n","    p.yaxis.major_label_text_color = \"#b2b5be\"\n","    p.yaxis.axis_line_width = 1.0\n","    p.yaxis.axis_line_color = \"#2a2e39\"\n","    p.border_fill_color = \"#181c27\"\n","    p.grid.grid_line_color = \"#2a2e39\"\n","    p.outline_line_color = \"#2a2e39\"\n","    p.xgrid.grid_line_dash = [2, 2]\n","    p.ygrid.grid_line_dash = [2, 2]\n","    p.xgrid.grid_line_alpha = 0\n","    p.ygrid.grid_line_alpha = 0\n","    p.xaxis.major_tick_line_color = None  # Убрать линии тиков по оси X\n","    p.yaxis.major_tick_line_color = None  # Убрать линии тиков по оси Y\n","    p.toolbar.autohide = True\n","\n","def create_data_sources(df: pd.DataFrame):\n","    \"\"\"Функция для создания источников данных для графиков\"\"\"\n","\n","    # Копируем датафрейм\n","    df = df.copy()\n","\n","    # Вычисляем центральную точку каждой свечи\n","    df['middle'] = (df['open'] + df['close']) / 2\n","\n","    # Вычисляем высоту и ширину каждой свечи\n","    df['height_inc'] = df['close'] - df['open']\n","    df['height_dec'] = df['open'] - df['close']\n","\n","    # Вычисляем цвет каждой свечи\n","    inc = df['close'] > df['open']\n","    dec = df['open'] > df['close']\n","\n","    # Создаем источники данных\n","    df_inc = ColumnDataSource(df[inc])\n","    df_dec = ColumnDataSource(df[dec])\n","    df_source = ColumnDataSource(df)\n","\n","    return df, df_inc, df_dec, df_source\n","\n","\n","def process_positions(df: pd.DataFrame,\n","                      positions_df: Optional[pd.DataFrame] = None,\n","                      open_position_timestamps: Optional[List[int]] = None,\n","                      close_position_timestamps: Optional[List[int]] = None,\n","                      stop_losses: Optional[List[float]] = None,\n","                      marker_sell_stop_color: str='red',\n","                      marker_sell_color: str='green',):\n","    \"\"\"Функция для обработки позиций и создания источников данных для графиков\"\"\"\n","\n","    # Если positions_df не передан, то используем списки open_position_timestamps, close_position_timestamps и stop_losses\n","    if positions_df is not None:\n","        required_position_columns = ['open_position_timestamp', 'close_position_timestamp', 'stop_loss']\n","        for col in required_position_columns:\n","            if col not in positions_df.columns:\n","                raise ValueError(f\"DataFrame с метками позиций должен содержать столбец '{col}'\")\n","    else:\n","        if open_position_timestamps is None or close_position_timestamps is None or stop_losses is None:\n","            raise ValueError(\"Необходимо передать либо positions_df, либо списки open_position_timestamps, close_position_timestamps и stop_losses\")\n","        positions_df = pd.DataFrame({\n","            'open_position_timestamp': open_position_timestamps,\n","            'close_position_timestamp': close_position_timestamps,\n","            'stop_loss': stop_losses\n","        })\n","\n","    # Преобразование дат в строковый формат\n","    positions_df['open_position_timestamp'] = pd.to_datetime(positions_df['open_position_timestamp'], unit='s')\n","    positions_df['close_position_timestamp'] = pd.to_datetime(positions_df['close_position_timestamp'], unit='s')\n","\n","\n","    # Вычисляем индексы позиций\n","    indices_buy = df.index[df['datetime'].isin(positions_df['open_position_timestamp'])].tolist()\n","    indices_sell = df.index[df['datetime'].isin(positions_df['close_position_timestamp'])].tolist()\n","\n","\n","    # Создаем источники данных\n","    num_candles_in_trade = []\n","    adjusted_sell_indices = []\n","    percent_moves = []\n","    open_prices = []\n","    close_prices = []\n","\n","\n","    # Обрабатываем позиции\n","    for i, buy_idx in enumerate(indices_buy):\n","        # Итерируемся по позициям\n","        if i < len(indices_sell):\n","            sell_idx = indices_sell[i]\n","            stop_loss = positions_df['stop_loss'].iloc[i]\n","            # Определяем есть ли стоп лосс\n","            if stop_loss is not None:\n","                stop_loss_hit = False\n","                for j in range(buy_idx, sell_idx):\n","                    if df['close'].iloc[j] < stop_loss:\n","                        sell_idx = j\n","                        stop_loss_hit = True\n","                        break\n","                if stop_loss_hit:\n","                    color = marker_sell_stop_color\n","                else:\n","                    color = marker_sell_color\n","            else:\n","                color = marker_sell_color\n","\n","            # Записываем данные\n","            num_candles_in_trade.append(sell_idx - buy_idx)\n","            percent_move = ((df['close'].iloc[sell_idx] - df['open'].iloc[buy_idx]) / df['open'].iloc[buy_idx]) * 100\n","            percent_moves.append(percent_move)\n","            adjusted_sell_indices.append((sell_idx, color))\n","            open_prices.append(df['open'].iloc[buy_idx])\n","            close_prices.append(df['close'].iloc[sell_idx])\n","        else:\n","            num_candles_in_trade.append(len(df) - buy_idx)\n","            adjusted_sell_indices.append((None, marker_sell_color))\n","            percent_moves.append(None)\n","            open_prices.append(df['open'].iloc[buy_idx])\n","            close_prices.append(None)\n","\n","    return indices_buy, adjusted_sell_indices, num_candles_in_trade, percent_moves, open_prices, close_prices\n","\n","\n","def create_markers_data(df, indices_buy, adjusted_sell_indices, num_candles_in_trade, percent_moves, open_prices, close_prices,\n","                        distance_buy, distance_sell, marker_buy_color, marker_sell_color, marker_sell_stop_color):\n","    marker_data_buy = {\n","        'datetime': df['datetime'][indices_buy],\n","        'y': df['low'][indices_buy] - distance_buy,\n","        'labels': np.arange(1, len(indices_buy) + 1).astype(str),\n","        'color': [marker_buy_color] * len(indices_buy),\n","        'num_candles': num_candles_in_trade\n","    }\n","\n","    marker_data_sell = {\n","        'datetime': [],\n","        'y': [],\n","        'labels': [],\n","        'color': [],\n","        'num_candles': [],\n","        'percent_move': [],\n","        'open_price': [],\n","        'close_price': []\n","    }\n","\n","    for i, buy_idx in enumerate(indices_buy):\n","        sell_idx, color = adjusted_sell_indices[i]\n","        if sell_idx is not None:\n","            marker_data_sell['datetime'].append(df['datetime'].iloc[sell_idx])\n","            marker_data_sell['y'].append(df['high'].iloc[sell_idx] + distance_sell)\n","            marker_data_sell['labels'].append(str(i + 1))\n","            marker_data_sell['num_candles'].append(sell_idx - buy_idx)\n","            marker_data_sell['color'].append(color)\n","            marker_data_sell['percent_move'].append(percent_moves[i])\n","            marker_data_sell['open_price'].append(df['open'].iloc[buy_idx])\n","            marker_data_sell['close_price'].append(df['close'].iloc[sell_idx])\n","\n","    return marker_data_buy, marker_data_sell\n","\n","\n","def plot_trading_signals(\n","        df: pd.DataFrame,\n","        positions_df: Optional[pd.DataFrame] = None,\n","        open_position_timestamps: Optional[List[int]] = None,\n","        close_position_timestamps: Optional[List[int]] = None,\n","        stop_losses: Optional[List[float]] = None,\n","        distance_buy: int = 5,\n","        distance_sell: int = 5,\n","        marker_buy_color: str = 'blue',\n","        marker_sell_color: str = 'green',\n","        marker_sell_stop_color: str = 'red',\n","        buy_marker: str = 'triangle',\n","        sell_marker: str = 'inverted_triangle',\n","        chart_width: int = 1000,\n","        chart_height: int = 400,\n","        profit_candle_color: str = '#0072B2',\n","        loss_candle_color: str = 'white',\n","        marker_size: int = 10,\n","        labels_color: str = 'white',\n","        candle_spacing: str = '35sec',\n","        width_slider_start: int = 200,\n","        width_slider_end: int = 1400,\n","        width_slider_step: int = 10,\n","        width_slider_value: int = 400,\n","        height_slider_value: int = 300,\n","        height_slider_start: int = 200,\n","        height_slider_end: int = 600,\n","        height_slider_step: int = 10,\n","        tools: str = 'wheel_zoom,pan,box_zoom,reset,save,undo',\n","        color_segment: str = '#787b86',\n","        y_axis_location: str = 'right',\n","        toolbar_location: str = 'above',\n","        line_width_curr: float = 0.5,\n","        line_color_curr: str = '#787b86',\n","        line_dash_curr: Union[str, List[int]] = 'dashed',\n","        horizontal_line_dash: Union[str, List[int]] = [4, 4],\n","        horizontal_line_color: str = '#2a2e39',\n","        horizontal_line_width: float = 1,\n","        show_horizontal_line: bool = True,\n","        title: Optional[str] = None,\n","        start_date_picker_title: str = 'Начальная дата',\n","        end_date_picker_title: str = 'Конечная дата',\n","        legend_location: str = 'top_right',\n","        legend_title: Optional[str] = None,\n","        legend_title_text_font_style: str = 'italic',\n","        legend_title_text_font_size: str = '10px',\n","        legend_label_text_color: str = \"#b2b5be\",\n","        legend_label_text_font: str = 'Helvetica',\n","        legend_label_text_font_style: str = 'normal',\n","        legend_label_text_font_size: str = '12px',\n","        legend_background_fill_color: str = '#181c27',\n","        legend_border_line_color: str = '#2a2e39',\n","        legend_border_line_width: float = 1,\n","        legend_border_line_alpha: float = 0.5,\n","        legend_background_fill_alpha: float = 0.5,\n","        title_text_color: str = '#b2b5be',\n","        marker_legend_label_buy: str = 'buy_signal',\n","        marker_legend_label_sell: str = 'sell_signal',\n",") -> figure:\n","    \"\"\"\n","    Создает график с торговыми сигналами на основе данных свечей с временными метками открытия/закрытия позиций и стоп-лоссами.\n","\n","    df: DataFrame с данными свечей (должны содержать столбцы 'datetime', 'open', 'high', 'low', 'close').\n","    positions_df: DataFrame с временными метками открытия и закрытия позиций, а также стоп-лоссами (должен содержать столбцы 'open_position_timestamp', 'close_position_timestamp', 'stop_loss').\n","    open_position_timestamps: Список временных меток открытия позиций.\n","    close_position_timestamps: Список временных меток закрытия позиций.\n","    stop_losses: Список стоп-лоссов для каждой сделки.\n","    distance_buy: Дистанция от свечи для маркеров покупок.\n","    distance_sell: Дистанция от свечи для маркеров продаж.\n","    marker_buy_color: Цвет маркеров покупок.\n","    marker_sell_color: Цвет маркеров продаж.\n","    marker_sell_stop_color: Цвет маркеров продаж при срабатывании стоп-лосса.\n","    buy_marker: Форма маркеров покупок.\n","    sell_marker: Форма маркеров продаж.\n","    chart_width: Ширина графика. По умолчанию 1000.\n","    chart_height: Высота графика. По умолчанию 400.\n","    loss_candle_color: Цвет свечей при убытке цены.\n","    profit_candle_color: Цвет свечей при возрастании цены.\n","    marker_size: Размер маркеров. По умолчанию 10.\n","    labels_color: Цвет меток. По умолчанию 'white'.\n","    candle_spacing: Расстояние между свечами. По умолчанию '35sec'.\n","    width_slider_start: Начальное значение ширины графика в виджете Slider. По умолчанию 200.\n","    width_slider_end: Конечное значение ширины графика в виджете Slider. По умолчанию 1400.\n","    width_slider_step: Шаг изменения ширины графика в виджете Slider. По умолчанию 10.\n","    width_slider_value: Значение по умолчанию для ширины графика в виджете Slider. По умолчанию 400.\n","    height_slider_value: Значение по умолчанию для высоты графика в виджете Slider. По умолчанию 300.\n","    height_slider_start: Начальное значение высоты графика в виджете Slider. По умолчанию 200.\n","    height_slider_end: Конечное значение высоты графика в виджете Slider. По умолчанию 600.\n","    height_slider_step: Шаг изменения высоты графика в виджете Slider. По умолчанию 10.\n","    tools: Набор инструментов для графика. По умолчанию \"wheel_zoom,pan,box_zoom,reset,save,undo\".\n","    color_segment: настройка цвета усиков свечей.\n","    y_axis_location: настройка расположения оси y. По умолчанию 'right'.\n","    toolbar_location: Настройка расположения набора инструментов. По умолчанию сверху.\n","    line_width_curr: ширина указательной линии. По умолчанию 0.5.\n","    line_color_curr: цвет указательной линии. По умолчанию '#787b86'.\n","    line_dash_curr: стиль линии. По умолчанию 'dashed'.\n","    horizontal_line_dash: стиль горизонтальной линии. По умолчанию [4, 4].\n","    horizontal_line_color: цвет горизонтальной линии. По умолчанию '#2a2e39'.\n","    horizontal_line_width: ширина горизонтальной линии. По умолчанию 1.\n","    show_horizontal_line: показывать ли горизонтальную линию. По умолчанию True.\n","    title: Заголовок графика. По умолчанию None.\n","    start_date_picker_title: Название кнопки для выбора начальной даты. По умолчанию 'Начальная дата'.\n","    end_date_picker_title: Название кнопки для выбора конечной даты. По умолчанию 'Конечная дата'.\n","    legend_location: расположение легенды. По умолчанию 'top_right'.\n","    legend_title: Заголовок легенды. По умолчанию None.\n","    legend_title_text_font_style: Стиль шрифта заголовка легенды. По умолчанию \"italic\".\n","    legend_title_text_font_size: Размер шрифта заголовка легенды. По умолчанию \"10px\".\n","    legend_label_text_color: Цвет меток легенды. По умолчанию \"#b2b5be\".\n","    legend_label_text_font: Шрифт меток легенды. По умолчанию \"Helvetica\".\n","    legend_label_text_font_style: Стиль шрифта меток легенды. По умолчанию \"normal\".\n","    legend_label_text_font_size: Размер шрифта меток легенды. По умолчанию \"12px\".\n","    legend_background_fill_color: Цвет фона легенды. По умолчанию '#181c27'.\n","    legend_border_line_color: Цвет границы легенды. По умолчанию '#2a2e39'.\n","    legend_border_line_width: Ширина границы легенды. По умолчанию 1.\n","    legend_border_line_alpha: Прозрачность границы легенды. По умолчанию 1.\n","    legend_background_fill_alpha: Прозрачность фона легенды. По умолчанию 0.5.\n","    title_text_color: Цвет заголовка. По умолчанию '#b2b5be'.\n","    marker_legend_label_buy: Название маркера покупки. По умолчанию 'buy_signal'.\n","    marker_legend_label_sell: Название маркера продажи. По умолчанию 'sell_signal'.\n","\n","    Returns:\n","        figure с графиком.\n","    \"\"\"\n","    # Проверка типов данных\n","    if not isinstance(df, pd.DataFrame):\n","        raise TypeError(\"Параметр 'df' должен быть pandas DataFrame.\")\n","    if positions_df is not None and not isinstance(positions_df, pd.DataFrame):\n","        raise TypeError(\"Параметр 'positions_df' должен быть pandas DataFrame.\")\n","    if positions_df is None and (open_position_timestamps is None or close_position_timestamps is None or stop_losses is None):\n","        raise ValueError(\"Необходимо передать либо positions_df, либо списки open_position_timestamps, close_position_timestamps и stop_losses\")\n","\n","    # Создаем источники данных\n","    df, df_inc, df_dec, df_source = create_data_sources(df)\n","\n","    # Обрабатываем позиции\n","    indices_buy, adjusted_sell_indices, num_candles_in_trade, percent_moves, open_prices, close_prices = process_positions(\n","        df, positions_df, open_position_timestamps, close_position_timestamps, stop_losses)\n","\n","    # Создаем данные для маркеров\n","    marker_data_buy, marker_data_sell = create_markers_data(\n","        df, indices_buy, adjusted_sell_indices, num_candles_in_trade, percent_moves, open_prices, close_prices,\n","        distance_buy, distance_sell, marker_buy_color, marker_sell_color, marker_sell_stop_color)\n","\n","    # Создаем график\n","    width1 = Span(dimension=\"width\", line_dash=line_dash_curr, line_width=line_width_curr, line_color=line_color_curr)\n","    height1 = Span(dimension=\"height\", line_dash=line_dash_curr, line_width=line_width_curr, line_color=line_color_curr)\n","\n","    p = figure(width=chart_width,\n","               height=chart_height,\n","               tools=[tools, CrosshairTool(overlay=[width1, height1])],\n","               y_axis_location=y_axis_location,\n","               toolbar_location=toolbar_location,\n","               active_scroll='wheel_zoom',\n","               active_drag='pan',\n","               x_axis_type=\"datetime\",\n","               toolbar_sticky=False,\n","               title=title,\n","               )\n","\n","    customize_plot_styles(p)\n","\n","    # Создаем мультилинию, используя источник данных\n","    source = ColumnDataSource(data=dict(xs=[], ys=[]))\n","    multi_line = p.multi_line('xs', 'ys', source=source)\n","\n","    tool = FreehandDrawTool(renderers=[multi_line])\n","    p.add_tools(tool)\n","\n","    # Добавление горизонтальной линии\n","    average_price = df['close'].mean()\n","    horizontal_line = Span(location=average_price, dimension='width', line_dash=horizontal_line_dash,\n","                           line_color=horizontal_line_color, line_width=horizontal_line_width)\n","    p.add_layout(horizontal_line)\n","\n","    # Добавление свечей и сегментов\n","    p.segment(x0='datetime', y0='high', x1='datetime', y1='low', source=df_source, color=color_segment)\n","    p.rect(x='datetime', y='middle', width=pd.Timedelta(candle_spacing), height='height_inc', source=df_inc,\n","           fill_color=profit_candle_color, line_color=profit_candle_color)\n","    p.rect(x='datetime', y='middle', width=pd.Timedelta(candle_spacing), height='height_dec', source=df_dec,\n","           fill_color=loss_candle_color, line_color=loss_candle_color)\n","\n","    # Добавление маркеров на график\n","    marker_source_buy = ColumnDataSource(data=marker_data_buy)\n","    marker_source_sell = ColumnDataSource(data=marker_data_sell)\n","    buy_glyph = p.scatter(x='datetime', y='y', source=marker_source_buy, size=marker_size, color='color', marker=buy_marker,\n","                          legend_label=marker_legend_label_buy)\n","    sell_glyph = p.scatter(x='datetime', y='y', source=marker_source_sell, size=marker_size, color='color', marker=sell_marker,\n","                           legend_label=marker_legend_label_sell)\n","\n","    # Добавление меток для маркеров\n","    labels_buy = LabelSet(x='datetime', y='y', text='labels', level='glyph', x_offset=0, y_offset=0,\n","                          source=marker_source_buy, text_color=labels_color, text_font_size='5pt', text_align='center',\n","                          text_baseline='middle')\n","    labels_sell = LabelSet(x='datetime', y='y', text='labels', level='glyph', x_offset=0, y_offset=0,\n","                           source=marker_source_sell, text_color=labels_color, text_font_size='5pt', text_align='center',\n","                           text_baseline='middle')\n","    p.add_layout(labels_buy)\n","    p.add_layout(labels_sell)\n","\n","    # Добавление HoverTool для маркеров\n","    hover_buy = HoverTool(renderers=[buy_glyph], tooltips=[(\"Кол-во свечей в сделке\", \"@num_candles\")])\n","    hover_sell = HoverTool(renderers=[sell_glyph],\n","                           tooltips=[\n","                               (\"Дата и время\", \"@datetime{%F %T}\"),\n","                               (\"Кол-во свечей в сделке\", \"@num_candles\"),\n","                               (\"Процент движения\", \"@percent_move{0.00} %\"),\n","                               (\"Цена открытия\", \"@open_price{0,0}\"),\n","                               (\"Цена закрытия\", \"@close_price{0,0}\")\n","                           ],\n","                           formatters={'@datetime': 'datetime', '@{adj close}': 'printf'})\n","    p.add_tools(hover_buy)\n","    p.add_tools(hover_sell)\n","\n","    # Настройка формата даты на оси x\n","    p.xaxis.formatter = DatetimeTickFormatter(\n","        hours=\"%H:%M\",\n","        minutes=\"%H:%M\",\n","        days=\"%d %b\",\n","        months=\"%b %Y\"\n","    )\n","\n","    hover = HoverTool(mode='vline', renderers=[p.renderers[1]])\n","    hover.tooltips = [\n","        (\"datetime\", \"@datetime{%F %T}\"),\n","        (\"open\", \"@open{0,0}\"),\n","        (\"high\", \"@high{0,0}\"),\n","        (\"low\", \"@low{0,0}\"),\n","        (\"close\", \"@close{0,0}\"),\n","        (\"volume\", \"@volume{0.00 a} m\"),\n","        (\"index\", \"@index\")\n","    ]\n","    hover.formatters = {'@datetime': 'datetime', '@{adj close}': 'printf'}\n","    hover.mode = \"mouse\"\n","    p.add_tools(hover)\n","\n","    # Создание виджетов и добавление их к графику\n","    width_slider = Slider(start=width_slider_start, end=width_slider_end, step=width_slider_step, value=width_slider_value)\n","    width_slider.js_link('value', p, 'width')\n","\n","    height_slider = Slider(start=height_slider_start, end=height_slider_end, step=height_slider_step, value=height_slider_value)\n","    height_slider.js_link('value', p, 'height')\n","\n","    start_date_str = df['datetime'].iloc[0].strftime('%Y-%m-%d')\n","    end_date_str = df['datetime'].iloc[-1].strftime('%Y-%m-%d')\n","\n","    start_date_picker = DatePicker(title=start_date_picker_title, value=start_date_str)\n","    end_date_picker = DatePicker(title=end_date_picker_title, value=end_date_str)\n","\n","    callback = CustomJS(args=dict(p=p, start_date_picker=start_date_picker, end_date_picker=end_date_picker), code=\"\"\"\n","        var start_date = new Date(start_date_picker.value).getTime();\n","        var end_date = new Date(end_date_picker.value).getTime();\n","        p.x_range.start = start_date;\n","        p.x_range.end = end_date;\n","    \"\"\")\n","\n","    start_date_picker.js_on_change('value', callback)\n","    end_date_picker.js_on_change('value', callback)\n","\n","    toggle1 = Toggle(label=\"horizontal_line\", button_type=\"success\", active=True)\n","    toggle1.js_link('active', horizontal_line, 'visible')\n","\n","    toggle_buy = Toggle(label=\"markers_buy\", button_type=\"success\", active=True)\n","    toggle_buy.js_link('active', buy_glyph, 'visible')\n","    toggle_buy.js_link('active', labels_buy, 'visible')\n","\n","    toggle_sell = Toggle(label=\"markers_sell\", button_type=\"success\", active=True)\n","    toggle_sell.js_link('active', sell_glyph, 'visible')\n","    toggle_sell.js_link('active', labels_sell, 'visible')\n","\n","    p.legend.location = legend_location\n","    p.legend.title = legend_title\n","    p.legend.title_text_font_style = legend_title_text_font_style\n","    p.legend.title_text_font_size = legend_title_text_font_size\n","    p.legend.label_text_color = legend_label_text_color\n","    p.legend.label_text_font = legend_label_text_font\n","    p.legend.label_text_font_style = legend_label_text_font_style\n","    p.legend.label_text_font_size = legend_label_text_font_size\n","    p.legend.background_fill_color = legend_background_fill_color\n","    p.legend.background_fill_alpha = legend_background_fill_alpha\n","    p.legend.border_line_width = legend_border_line_width\n","    p.legend.border_line_color = legend_border_line_color\n","    p.legend.border_line_alpha = legend_border_line_alpha\n","\n","    if title is not None:\n","        p.title.text_color = title_text_color\n","\n","    layout = column(row(start_date_picker, end_date_picker), width_slider, height_slider, row(toggle1, toggle_buy, toggle_sell), p)\n","    show(layout)\n","\n","\n","# Пример использования функции\n","open_timestamps = [1577103060, 1577104980, 1577107680]\n","close_timestamps = [1577104020, 1577105820, None]\n","stop_losses = [7543, 7541, None]\n","\n","# Предполагается, что `df` уже создан и содержит необходимые данные\n","plot_trading_signals(df, open_position_timestamps=open_timestamps, close_position_timestamps=close_timestamps, stop_losses=stop_losses)\n"],"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":612,"output_embedded_package_id":"1wNyN39E-q93BPvj6gHqOBc9q-xdHecCs"},"id":"RYcPzhozuUoK","executionInfo":{"status":"ok","timestamp":1719318423093,"user_tz":-180,"elapsed":3849,"user":{"displayName":"Loraq","userId":"14699525697725059408"}},"outputId":"c90aa02e-08dc-4fa2-959a-0f4091ffd5ca"},"execution_count":null,"outputs":[{"output_type":"display_data","data":{"text/plain":"Output hidden; open in https://colab.research.google.com to view."},"metadata":{}}]}],"metadata":{"colab":{"provenance":[{"file_id":"1uAZiRdBlk_RLNeOQR5YoHPRT1J5LYXGv","timestamp":1719316832571}],"mount_file_id":"1TTIgGn5ld4gxjoZXtRKRVUo3hKSG9Mbw","authorship_tag":"ABX9TyMYNPz+dkhrNVfNfs4oQ7bi"},"kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"name":"python"}},"nbformat":4,"nbformat_minor":0}